rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check channel admin
    function isChannelAdmin(channelId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/channels/$(channelId)/members/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isAuthenticated();
      
      // Only the user can create their own document
      allow create: if isOwner(userId) && 
        request.resource.data.id == userId &&
        request.resource.data.username is string &&
        request.resource.data.email is string;
      
      // Only the user can update their own document
      // Restrict which fields can be updated
      allow update: if isOwner(userId) && (
        // Allow updating username
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['username']) ||
        // Allow updating blocked/muted users
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['blockedUsers']) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['mutedUsers']) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['blockedUsers', 'mutedUsers'])
      );
      
      // Users cannot delete their profile directly (handled by Cloud Functions)
      allow delete: if false;
    }
    
    // Active Users collection
    match /activeUsers/{userId} {
      // Anyone authenticated can read active users (for nearby user count)
      allow read: if isAuthenticated();
      
      // Only the user can create/update their own active user document
      allow create, update: if isOwner(userId) &&
        request.resource.data.id == userId &&
        request.resource.data.username is string &&
        request.resource.data.geohash is string &&
        request.resource.data.proximityChannel is string;
      
      // Users can delete their own active user document
      allow delete: if isOwner(userId);
    }
    
    // Reports collection
    match /reports/{reportId} {
      // Only authenticated users can create reports
      allow create: if isAuthenticated() &&
        request.resource.data.reporterUserId == request.auth.uid &&
        request.resource.data.reportedUserId is string &&
        request.resource.data.reason is string &&
        request.resource.data.status == 'pending';
      
      // Users can read their own reports (as reporter)
      allow read: if isAuthenticated() && 
        resource.data.reporterUserId == request.auth.uid;
      
      // Reports cannot be updated or deleted by users
      allow update, delete: if false;
    }
    
    // Blocked Zones collection (read-only for users)
    match /blockedZones/{zoneId} {
      // Anyone authenticated can read blocked zones
      allow read: if isAuthenticated();
      
      // Only admins can create/update/delete (handled by Firebase Admin SDK)
      allow create, update, delete: if false;
    }

    // P2P signaling sessions (ephemeral)
    match /p2pSessions/{sessionId} {
      allow read, write: if isAuthenticated();

      // per-peer signaling docs for mesh
      match /peers/{peerId} {
        allow read, write: if isAuthenticated();
      }
    }

    // Channels collection
    match /channels/{channelId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() &&
        request.resource.data.keys().hasOnly(['name', 'passcodeHash', 'createdBy', 'createdAt']) &&
        request.resource.data.name is string &&
        request.resource.data.passcodeHash is string &&
        request.resource.data.createdBy == request.auth.uid;

      // Allow updates only by channel admins
      allow update: if isChannelAdmin(channelId);

      // Members subcollection
      match /members/{memberId} {
        allow read: if isAuthenticated();

        // Join allowed if passcodeHash matches channel or writer is admin
        allow create: if isAuthenticated() &&
          (memberId == request.auth.uid || isChannelAdmin(channelId)) &&
          (
            isChannelAdmin(channelId) || (
              request.resource.data.passcodeHash is string &&
              request.resource.data.passcodeHash == get(/databases/$(database)/documents/channels/$(channelId)).data.passcodeHash
            )
          ) &&
          request.resource.data.role is string &&
          request.resource.data.joinedAt is timestamp;

        // Admins can add or promote others
        allow update: if isChannelAdmin(channelId);

        // Admins or the member themselves can delete membership
        allow delete: if isChannelAdmin(channelId) || (isAuthenticated() && memberId == request.auth.uid);
      }
    }
    
    // Increment report count (special rule for reports)
    // This allows the report creation to also increment the user's report count
    match /users/{userId} {
      allow update: if isAuthenticated() && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reportCount']) &&
        request.resource.data.reportCount == resource.data.reportCount + 1;
    }
  }
}
